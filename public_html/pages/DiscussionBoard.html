<!-- Name: Junji Duan   e-mail: junji.duan@mail.mcgill.ca -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discussion Board</title>
    <link href="../cgi_bin/bootstrap/bootstrap.min.css" rel="stylesheet">
    
    <style>

        body {
            font-family: Arial, sans-serif;
        }

         /* Adjust row to work inside a flex container */
         .row {
            display: flex;
            flex-grow: 1; /* Allow row to grow and fill space */
        }
    
        .container-fluid {
            display: flex;
            min-height: 100vh;
        }
    
        .sidebar {
            flex: 0 0 200px;
            min-height: 100vh;
            background-color: #f8f9fa; /* Light grey background */
            padding: 10px;
            box-shadow: 2px 0px 5px rgba(0,0,0,0.1);
        }
    
        .sidebar a, .sidebar div {
            /* display: block; */
            padding: 8px 10px;
            margin: 5px 0;
            color: #333;
            text-decoration: none;
        }
    
        .sidebar a:hover, .sidebar div:hover {
            background-color: #e9ecef; /* Light hover effect */
        }

        .mycourses-link{
            text-align: center;
        }

    
        .search-box {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            align-items: center;
        }

        .make-post {
            font-weight: bold;
            color: #007bff; /* Bootstrap primary color */
        }

        .manage-system {
            font-weight: bold;
            color: #007bff; /* Bootstrap primary color */
        }
    
        .content-area {
            padding: 20px;
            background-color: #fff;
            border-left: 1px solid #ced4da;
            min-height: 100vh; 
        }
    
        .post-list {
            list-style-type: none;
            overflow-y: auto;
            height: 35vh;
            padding: 0;
        }
    
        .post-list div {
            cursor: pointer;
            border-bottom: 1px solid #ddd;
            padding: 10px;
        }
    
        .post-list div:hover {
            background-color: #f5f5f5;
        }

        .welcome {
            position: relative; /* Allows absolute positioning of children */
            display: block;
            background: 
                linear-gradient(
                to top,
                rgba(200, 200, 255, 0),
                rgba(0, 0, 100, 0.5)
                ),
                url(../asserts/images/welcome2.jpg);
            min-height: 95vh;
            background-size: cover;
            position: relative; 
            padding: 20px; 
            margin-top: 22px; /* Adds 20px space above the welcome section */
        }

        .welcome-text {
            margin-top: 1rem;
            font-family: Tahoma, Arial, sans-serif;
            font-weight: bold;
            text-align: center;
            color: white;
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .spacer {
            height: 100px; 
        }

        .manage-board-member, .manage-channels, .manage-channel-members, #join {
            position: absolute;
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .manage-channels {
            top: 160px;
            left: 430px;  /*Position at lower-left corner */
        }

        .manage-board-member {
            top: 160px;
            right: 430px; /* Position at lower-right corner */
        }

        .manage-channel-members {
            bottom: 160px;
            right: 430px; /* Position at lower-right corner */
        }

        .comment-section {
            margin-top: 20px;
        }

        #commentText {
            margin-bottom: 10px;
        }

        /* Anna: modals */
        .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        }

        /* The Close Button */
        .close {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }

        .close:hover,
        .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
        }

        .channel {
            font-size: 0.8em;
            padding: 0.2em 0.5em;
            border-radius: 1em;
        }

        .channel-select {
            border-radius: 2em;
        }

        .channel-select:hover {
            cursor: pointer;
        }

        .time {
            font-size: 0.8em;
            color: darkgray;
        }

        #filterChannel button {
            font-size: 1.5vw;
        }

        .view-waiting-list {
            font-weight: bold;
        }

        .view-waiting-list:hover {
            cursor: pointer;
        }

        .group {
            background-color: gold;
            border-radius: 1em;
            font-size: 0.8em;
            padding: 0.2em 0.5em;
        }

    </style>

</head>

<body>
    <div class="container-fluid">
        <!-- Main row for sidebar and content area -->
        <div class="row">

            <!-- Left Sidebar -->
            <div class="col-md-2 sidebar">
                <!-- Navigation and utility links in sidebar -->
                <a href="SelectBoard.html" class="mycourses-link"><b>My Courses</b></a>
                <div class="make-post" id="makepost">Make a Post</div>
                <div class="manage-system" id="managesystem">Manage System</div>
                <div class="view-waiting-list" id="viewwaitinglist">View Waiting List</div>

                <div class="dropdown" id="filterChannel">
                    <button class="btn btn-secondary dropdown-toggle channel-select" type="button" data-toggle="dropdown" aria-expanded="false">
                        All channels
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-item">
                            <span class="btn-secondary channel-select" style="padding: 0.5em" value="-1">All channels</span>
                        </div>
                    </div>
                </div>
                <input type="text" class="form-control search-box" placeholder="Search posts...">
                <!-- List where posts will be dynamically added -->
                <div class="post-list"></div>
            </div>

            <!-- Right Content Area -->
            <div class="col-md-10" id="contentArea">
                <!-- Area where the content of posts will be displayed -->
                <div id="postDisplayArea"></div>

                <!-- 'Make a Post' Form -->
                <div id="makepostSection" style="display: none;">
                    <input type="text" class="form-control" id="postTitle" placeholder="Post Title" style="margin-bottom: 10px;">
                    <textarea class="form-control" id="postContent" rows="4" placeholder="Post Content" style="margin-bottom: 10px;"></textarea>
                    <select class="form-control" id="postVisibility" style="margin-bottom: 10px;">
                        <option value="private">Private</option>
                        <option value="public">Public</option>
                    </select>
                    <button class="btn btn-primary" id="submitPost">Post</button>
                </div>

            </div>

        </div>
    </div>

    <!-- Including Bootstrap JavaScript for functionality -->
    <script src="../cgi_bin/bootstrap/jquery.min.js"></script>
    <script src="../cgi_bin/bootstrap/popper.min.js"></script>
    <script src="../cgi_bin/bootstrap/bootstrap.min.js"></script>
    <script src="../cgi_bin/connection.js"></script>

    <script>
        // Dummy data for posts (used for demonstration purposes)
        let posts = [
            // { title: "Post 1", content: "Content for Post 1" },
            // { title: "Post 2", content: "Content for Post 2" },
            // { title: "Post 3", content: "Content for Post 3" },
            // { title: "Post 4", content: "Content for Post 1" },
            // { title: "Post 5", content: "Content for Post 2" },
            // { title: "Post 6", content: "Content for Post 3" },
            // Add more post data as needed
        ];

        let connection = null
        async function init(){
            try {
                connection = await Connection.connect()
                let user_boards = await connection.getBoards()
                let id = parseInt(getUrlParameter('course'))
                let found = false
                let exists = false
                let name = ""
                user_boards.forEach(row => {
                    if (row.board_id == id) {
                        found = true
                        exists = true
                        name = row.board_name
                    }
                })
                if (!found) {
                    let all_boards = await connection.searchBoards("")
                    all_boards.forEach(row => {
                        if (row.board_id == id) {
                            exists = true
                            name = row.board_name
                        }
                    })
                }
                handleCourseSpecificLogic(found, exists, name)
                if (found) {
                    let result = await connection.setBoard(id)
                    if (!result.success) {
                        throw new Error("Server refused to set board")
                    }
                    posts = await connection.getBoardMessages()
                    let channelSelect = document.getElementById('postVisibility')
                    let channelFilter = document.getElementById('filterChannel')
                    channelSelect.innerHTML = ""
                    let channels = await connection.getChannels()
                    channels.forEach(channel => {
                        let option = document.createElement("option")
                        option.text = channel.channel_name
                        option.value = channel.channel_id
                        channelSelect.appendChild(option)

                        let parent = document.createElement('div')
                        parent.classList.add("dropdown-item")
                        let item = document.createElement('span')
                        item.classList.add("channel-select")
                        item.style.padding = '0.5em'
                        item.style.color = 'black'
                        item.style.backgroundColor = `hsl(` + ((channel.channel_id*130)%360) + `,100%,75%)`
                        item.innerHTML = channel.channel_name
                        item.setAttribute("value", channel.channel_id)
                        parent.appendChild(item)
                        parent.addEventListener('click', filterByChannel)
                        channelFilter.getElementsByClassName('dropdown-menu')[0].appendChild(parent)
                    })
                    channelFilter.getElementsByClassName('dropdown-menu')[0].children[0].addEventListener('click', filterByChannel)
                } else {
                    posts = []
                }
                displayPosts()
                return found
            } catch (error) {
                if (error instanceof TypeError) {
                    throw error
                }
                window.location.replace("../landingpage.html")
            }
        }

        let activeChannel = -1

        function filterByChannel(event) {
            let active = document.getElementById('filterChannel').getElementsByClassName('dropdown-toggle')[0]
            active.innerHTML = event.target.innerHTML
            let value = event.target.getAttribute("value")
            active.setAttribute("value", value)
            active.style.backgroundColor = event.target.style.backgroundColor
            active.style.color = event.target.style.color
            active.style.borderColor = "transparent"

            activeChannel = parseInt(value)
            filterPosts(document.getElementsByClassName('search-box')[0].value)
        }

        function legibleTime(time) {
            let returnTime = 0;
            let returnString = ""
            // if (time / 1000 < 1) {
            //     returnTime = Math.floor(time)
            //     returnString = " millisecond";
            // } else
            if (time / (60*1000) < 1) {
                returnTime = Math.floor(time / 1000)
                returnString = " second"
            } else if (time / (60*60*1000) < 1) {
                returnTime = Math.floor(time / (60*1000))
                returnString = " minute"
            } else if (time / (24*60*60*1000) < 1) {
                returnTime = Math.floor(time / (60*60*1000))
                returnString = " hour"
            } else if (time / (7*24*60*60*1000) < 1) {
                returnTime = Math.floor(time / (24*60*60*1000))
                returnString = " day"
            } else if (time / (30*24*60*60*1000) < 1) {
                returnTime = Math.floor(time / (7*24*60*60*1000))
                returnString = " week"
            } else if (time / (365*24*60*60*1000) < 1) {
                returnTime = Math.floor(time / (30*24*60*60*1000))
                returnString = " month"
            } else {
                returnTime = Math.floor(time / (365*24*60*60*1000))
                returnString = " year"
            }
            return returnTime + returnString + (returnTime > 1 || returnTime == 0 ? "s" : "")
        }

        // Function to extract URL parameters (e.g., 'course' from the query string)
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Logic specific to handling course-related features
        function handleCourseSpecificLogic(isValidUser, boardExists, courseName) {
            // Create a new element for the welcome section
            const welcomeSection = document.createElement('div');
            welcomeSection.id = 'welcomeSection';
            welcomeSection.className = 'welcome';

            // Add a spacer div to adjust the height
            const spacerDiv = document.createElement('div');
            spacerDiv.className = 'spacer';
            welcomeSection.appendChild(spacerDiv);

            // Create an inner text container
            const welcomeTextDiv = document.createElement('div');
            welcomeTextDiv.className = 'welcome-text';

            // Add welcome message and course name
            // <h1>Discussion Board for ${courseName}</h1>
            welcomeTextDiv.innerHTML = `
            <h1>Discussion Board for ${courseName}</h1>
            <div class="manage-buttons">
                <button class="btn btn-primary" id="manageMembersBtn" onclick="window.location.href='../cgi_bin/manageMembers.php'">Manage Members</button>
                <button class="btn btn-primary" id="manageChannelsBtn" onclick="window.location.href='../cgi_bin/manageChannels.php'">Manage Channels</button>
                <button class="btn btn-primary" id="manageChannelMembersBtn" onclick="window.location.href='../cgi_bin/manageChannelMembers.php'">Manage Channel Members</button>

            </div>
            `;

            // Append the text container to the welcome section
            welcomeSection.appendChild(welcomeTextDiv);


            // Add the welcome section to the content area
            const contentArea = document.getElementById('contentArea');
            contentArea.prepend(welcomeSection);

            if (!boardExists) {
                welcomeTextDiv.innerHTML = "<h1>Board not found</h1>"
                return
            }

            if (!isValidUser) {
                welcomeTextDiv.innerHTML = "<h3>You must be a member of this board to view the content</h3>"
                return
            }

            /* Create Manage Board Members button
            const manageBoardMemberButton = document.createElement('div');
            manageBoardMemberButton.className = 'manage-board-member';
            manageBoardMemberButton.id = 'manageBoardMember';
            manageBoardMemberButton.textContent = 'Manage Board Members';
    
            // Create Manage Channels button
            const manageChannelsButton = document.createElement('div');
            manageChannelsButton.className = 'manage-channels';
            manageChannelsButton.id = 'manageChannels';
            manageChannelsButton.textContent = 'Manage Channels';

            // Create Manage Channel Members button
            const manageChannelMembersButton = document.createElement('div');
            manageChannelMembersButton.className = 'manage-channel-members';
            manageChannelMembersButton.id = 'manageChannelMembers';
            manageChannelMembersButton.textContent = 'Manage Channel Members';*/
            // <div class="manage-buttons">
            //     <div class="manage-board-member" id="manageBoardMember">Manage Board Members</div>
            //     <div class="manage-channels" id="manageChannels">Manage Channels</div>
            //     <div class="manage-channel-members" id="manageChannelMembers">Manage Channel Members</div>
            // </div>

            /* Create Manage Channel Members button
            const viewWaitingListButton = document.createElement('div');
            viewWaitingListButton.className = 'view-waiting-list';
            viewWaitingListButton.id = 'viewWaitingList';
            viewWaitingListButton.textContent = 'View Waiting List';*/

            /* Create Manage Channel Members button
            const viewWaitingListButton = document.createElement('div');
            viewWaitingListButton.className = 'view-waiting-list';
            viewWaitingListButton.id = 'viewWaitingList';
            viewWaitingListButton.textContent = 'View Waiting List';*/

            // Append buttons to the welcome section
            /*
            welcomeSection.appendChild(manageBoardMemberButton);
            welcomeSection.appendChild(manageChannelsButton);
            welcomeSection.appendChild(manageChannelMembersButton); */

            // welcomeSection.appendChild(viewWaitingListButton);

            //  Event listeners for buttons:
            // document.getElementById('manageBoardMember').addEventListener('click', function() {
            //     try {
            //         window.location.href = '../cgi_bin/manageMembers.php';
            //     } catch (error) {
            //         console.error('Error navigating to manageMembers.php:', error);
            //     }
            // });

            // document.getElementById('manageChannels').addEventListener('click', function() {
            //     try {
            //         window.location.href = '../cgi_bin/manageChannels.php';
            //     } catch (error) {
            //         console.error('Error navigating to manageChannels.php:', error);
            //     }
            // });

            // document.getElementById('manageChannelMembers').addEventListener('click', function() {
            //     try {
            //         window.location.href = '../cgi_bin/manageChannelMembers.php';
            //     } catch (error) {
            //         console.error('Error navigating to manageChannelMembers.php:', error);
            //     }
            // });

            document.getElementById('viewwaitinglist').addEventListener('click', function() {
                try {
                    window.location.href = '../cgi_bin/waitlist.php';
                } catch (error) {
                    console.error('Error navigating to manageChannelMembers.php:', error);
                }
            });

            document.getElementById('viewwaitinglist').addEventListener('click', function() {
                try {
                    window.location.href = '../cgi_bin/manageChannelMembers.php';
                } catch (error) {
                    console.error('Error navigating to manageChannelMembers.php:', error);
                }
            });

        }
        
        // Event listener for 'Manage System' button click
        document.getElementById('managesystem').addEventListener('click', function() {
            const welcomeSection = document.getElementById('welcomeSection');
            welcomeSection.style.display = 'block'; // Show the welcome section

            // Clear the previously displayed post content
            const postDisplayArea = document.getElementById('postDisplayArea');
                postDisplayArea.innerHTML = '';

            // Hide 'Make a Post' form section
            const makepostSection = document.getElementById('makepostSection');
            if (makepostSection) {
                makepostSection.style.display = 'none';
            }

        });

        document.getElementById('viewwaitinglist').addEventListener('click', function() {
            const welcomeSection = document.getElementById('welcomeSection');
            welcomeSection.style.display = 'block'; // Show the welcome section

            // Clear the previously displayed post content
            const postDisplayArea = document.getElementById('postDisplayArea');
                postDisplayArea.innerHTML = '';

            // Hide 'Make a Post' form section
            const makepostSection = document.getElementById('makepostSection');
            if (makepostSection) {
                makepostSection.style.display = 'none';
            }

        });
        
        // Display make a post page
        document.addEventListener('DOMContentLoaded', function() {
            init().then(result => {
                if (result) {
                    // Event listener for 'Make a Post'
                    document.getElementById('makepost').addEventListener('click', function() {
                        
                        // Hide welcome section
                        if (welcomeSection) {
                            welcomeSection.style.display = 'none';
                        }

                        // Clear the previously displayed post content
                        const postDisplayArea = document.getElementById('postDisplayArea');
                        postDisplayArea.innerHTML = '';

                        // Display the 'Make a Post' form section
                        const makepostSection = document.getElementById('makepostSection');
                        makepostSection.style.display = 'block';
                    });

                    document.getElementById('submitPost').addEventListener('click', function () {
                        let title = document.getElementById('postTitle')
                        let content = document.getElementById('postContent')
                        let channel = document.getElementById('postVisibility')
                        connection.sendMessage(title.value, content.value, parseInt(channel.value)).then(function () { 
                            let postTitle = title.value;
                            title.value = ""
                            content.value = ""
                            refreshPosts(postTitle)
                        }).catch(error => {
                            console.error(error)
                        })
                    })
                }
            })
        });
    
        // Function to display posts in the sidebar
        function displayPosts(filteredPosts = posts) {
            const postList = document.querySelector('.post-list');
            postList.innerHTML = ''; // Clear existing posts
    
            let threads = []
            filteredPosts.forEach(post => {
                let exists = false
                threads.forEach(thread => {
                    if (post.message_title == thread[0].message_title && post.channel_id == thread[0].channel_id) {
                        thread.unshift(post)
                        exists = true
                    }
                })
                if (!exists) {
                    threads.push([post])
                }
            })

            threads.forEach(thread => {
                const postElement = document.createElement('div');
                postElement.classList.add('sidebar-link');
                postElement.textContent = thread[0].message_title //post.title;
                postElement.onclick = () => displayPostContent(thread);
                postList.appendChild(postElement);
            });

        }
    
        // Function to display post content
        function displayPostContent(posts) {
            const contentArea = document.getElementById('postDisplayArea');
//            const postContent = `<h3>${post.title}</h3><p>${post.content}</p>`;
            let postContent = `<h3 style="margin: 0.5em 0">${posts[0].message_title} <span class='channel' style='background-color: hsl(` + ((posts[0].channel_id*130)%360) + `,100%,75%)'>${posts[0].channel_name}</span></h3>`
            posts.forEach(post => {
                postContent += `<h5>${post.author} <span class='group'>${post.group_name}</span> <span class="time">` + legibleTime(new Date() - new Date(post.message_time)) + ` ago</span></h5><p>${post.message_text}</p>`;
            })
            
            // Add a textarea for comments
            const commentSection = `
                <div class="comment-section">
                    <textarea class="form-control" id="commentText" rows="2" placeholder="Add a comment..."></textarea>
                    <button class="btn btn-primary" id="postComment">Post Comment</button>
                </div>
            `;

            // Replace existing content in contentArea with the new post content
            contentArea.innerHTML = postContent + commentSection;

            // Add event listener to the Post Comment button
            document.getElementById('postComment').addEventListener('click', function() {
                postComment(posts[0].message_title, posts[0].channel_id); // You might want to pass an identifier for the post
            });

            // Hide 'Make a Post' form section
            const makepostSection = document.getElementById('makepostSection');
            if (makepostSection) {
                makepostSection.style.display = 'none';
            }
            
            // Hide welcome section
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
        }

        // Initial display of all posts
        // displayPosts(); 

        // Event listener for search functionality
        document.querySelector('.search-box').addEventListener('input', function(event) {
            filterPosts(event.target.value)
        });

        function filterPosts(query) {
            const searchTerm = query.toLowerCase();
            const filteredPosts = posts.filter(post => (post.channel_id == activeChannel || activeChannel == -1) && (post.message_title.toLowerCase().includes(searchTerm) || post.message_text.toLowerCase().includes(searchTerm) || post.author.toLowerCase().includes(searchTerm)));
            displayPosts(filteredPosts);
        }

        function postComment(postTitle, channel_id) {
            const commentText = document.getElementById('commentText').value;
            // Logic to handle the comment post
            // For example, send the comment to your server and then update the UI
            //console.log("Comment on post", postTitle, ":", commentText);
            connection.sendMessage(postTitle, commentText, channel_id).then(status => {
                refreshPost(postTitle)
            })

            // Clear the comment textarea after posting
            document.getElementById('commentText').value = '';
        }

        function refreshPost(postTitle) {
            connection.getBoardMessages().then(newPosts => {
            posts = newPosts
            displayPosts()
            Object.values(document.getElementsByClassName('sidebar-link')).forEach(link => {
                if (link.innerHTML === postTitle) {
                    link.click()
                }
            })
        })
        }

    </script>
    
</body>
</html>
